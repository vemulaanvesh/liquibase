parameters:
  environmentName: ''
  azureSubscription: ''
  KeyVaultName: ''
  sql_servername: ''
  sql_database: ''
  sql_login: ''
  secrets_Filter: ''
  sql_dacpac_path: ''
  
jobs:
- deployment: ${{ replace(parameters.sql_database, '-', '_') }}_${{ parameters.environmentName }}_Deploy # Jobs cannot have hyphens, thus we must swap for an underscore here using replace function
  displayName: "Deploy DACPAC"
  environment: ${{ parameters.environmentName }}
  strategy:
    runOnce:
      deploy:
        steps:
        
        # Download build artifacts
        # Download files that were saved as artifacts of a completed build
        - task: Docker@2
          displayName: 'Download Build Artifacts'
          inputs:
            containerRegistry: 'dockerhub'
            repository: 'anveshvemula/liqu'
            command: 'build'
            Dockerfile: '**/Dockerfile'
        - bash: |
            sudo docker run --rm -v changelog.xml:/liquibase/changelog.xml anveshvemula/liqu:$(Build.BuildId) --changeLogFile=/changelog.xml --url="jdbc:sqlserver://$(host);USER=$(USER);PASSWORD=$(PASSWORD);" update
        

# # Docker
# # Build a Docker image
# # https://docs.microsoft.com/azure/devops/pipelines/languages/docker

# trigger:
# - master

# resources:
# - repo: self

# variables:
#   tag: '$(Build.BuildId)'

# stages:
# - stage: Build
#   displayName: Build image
#   jobs:
#   - job: Build
#     displayName: Build
#     pool:
#       vmImage: ubuntu-latest
#     steps:
#     - task: Docker@2
#       inputs:
#         containerRegistry: 'dockerhub'
#         repository: 'anveshvemula/liqu'
#         command: 'build'
#         Dockerfile: '**/Dockerfile'
#     - bash: |
#         sudo docker run --rm -v changelog.xml:/liquibase/changelog.xml anveshvemula/liqu:$(Build.BuildId) --changeLogFile=/changelog.xml --url="jdbc:sqlserver://$(host);USER=$(USER);PASSWORD=$(PASSWORD);" update
        
